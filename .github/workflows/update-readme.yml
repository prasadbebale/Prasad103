name: Update README

on:
  schedule:
    - cron: '0 0 * * *'  # Runs daily at midnight UTC
  workflow_dispatch:  # Allows manual trigger
  push:
    branches:
      - main

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - uses: lowlighter/metrics@latest
        with:
          filename: metrics.svg
          token: ${{ secrets.GITHUB_TOKEN }}
          base: header, activity, community, repositories, metadata
          plugin_isocalendar: yes
          plugin_isocalendar_duration: full-year
          config_timezone: Asia/Kolkata  # Adjust to user's timezone
      - name: Fetch Random Quote
        run: |
          QUOTE=$(curl -s https://api.quotable.io/random | jq -r '.content + " â€” " + .author')
          echo "RANDOM_QUOTE=$QUOTE" >> $GITHUB_ENV
      - name: Update README
        run: |
          # Replace or add the quote
          if grep -q "<!-- RANDOM_QUOTE -->" README.md; then
            sed -i "s|<!-- RANDOM_QUOTE -->.*<!-- END_QUOTE -->|<!-- RANDOM_QUOTE -->\n> $RANDOM_QUOTE\n<!-- END_QUOTE -->|" README.md
          else
            sed -i "/^# Prasad Bebale's GitHub Profile$/a \\\n<!-- RANDOM_QUOTE -->\n> $RANDOM_QUOTE\n<!-- END_QUOTE -->" README.md
          fi
          # Add the SVG to README if not present
          if ! grep -q "metrics.svg" README.md; then
            echo -e "\n### GitHub Activity Calendar:\n\n<p align=\"center\">\n  <img src=\"metrics.svg\" alt=\"GitHub Activity Calendar\" />\n</p>" >> README.md
          fi
      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: Update GitHub metrics
          file_pattern: README.md metrics.svg